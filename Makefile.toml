# School Payment Advisor - Task Runner
# ä½¿ã„æ–¹: makers <task-name>

[config]
skip_core_tasks = true

[env]
PROJECT_ROOT = "${CARGO_MAKE_WORKING_DIRECTORY}"
PATH = "${HOME}/.elan/bin:${PATH}"

[tasks.default]
description = "åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º"
script = '''
echo "ğŸ“š å¿—æœ›æ ¡æ”¯æ‰•ã„ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ - ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼"
echo ""
echo "åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯:"
echo "  makers dev        - å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ï¼ˆæ¨å¥¨ï¼‰"
echo "  makers dev-front  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿èµ·å‹•"
echo "  makers dev-api    - APIã‚µãƒ¼ãƒãƒ¼ã®ã¿èµ·å‹•"
echo "  makers dev-lean   - Lean REPLã®ã¿èµ·å‹•"
echo ""
echo "  makers build      - å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰"
echo "  makers build-lean - Leanãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰"
echo "  makers build-front - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰"
echo "  makers build-api  - APIã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ“ãƒ«ãƒ‰"
echo ""
echo "  makers install    - å…¨ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
echo "  makers clean      - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤"
echo "  makers test-lean  - Leanã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
'''

# ============ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ ============

[tasks.dev]
description = "å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä¸¦åˆ—èµ·å‹•ï¼ˆFrontend + API + Lean REPLï¼‰"
run_task = { name = ["dev-lean", "dev-api", "dev-front"], parallel = true }

[tasks.dev-front]
description = "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
script = '''
cd ${PROJECT_ROOT}/frontend && npm run dev
'''

[tasks.dev-api]
description = "APIã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
script = '''
cd ${PROJECT_ROOT}/api-server && npm run dev
'''

[tasks.dev-lean]
description = "Lean REPLã‚’èµ·å‹•"
script = '''
cd ${PROJECT_ROOT}/lean-backend && lake exe advisor --repl
'''

# ============ ãƒ“ãƒ«ãƒ‰ ============

[tasks.build]
description = "å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰"
dependencies = ["build-lean", "build-api", "build-front"]

[tasks.build-lean]
description = "Leanãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰"
script = '''
echo "ğŸ”¨ Leanãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
cd ${PROJECT_ROOT}/lean-backend && lake build
echo "âœ… Leanãƒ“ãƒ«ãƒ‰å®Œäº†"
'''

[tasks.build-front]
description = "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰"
script = '''
echo "ğŸ”¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
cd ${PROJECT_ROOT}/frontend && npm run build
echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰å®Œäº†"
'''

[tasks.build-api]
description = "APIã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ“ãƒ«ãƒ‰"
script = '''
echo "ğŸ”¨ APIã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
cd ${PROJECT_ROOT}/api-server && npm run build
echo "âœ… APIã‚µãƒ¼ãƒãƒ¼ãƒ“ãƒ«ãƒ‰å®Œäº†"
'''

# ============ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ============

[tasks.install]
description = "å…¨ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
script = '''
echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."

echo "  â†’ Leanä¾å­˜é–¢ä¿‚..."
cd ${PROJECT_ROOT}/lean-backend && lake update

echo "  â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚..."
cd ${PROJECT_ROOT}/frontend && npm install

echo "  â†’ APIã‚µãƒ¼ãƒãƒ¼ä¾å­˜é–¢ä¿‚..."
cd ${PROJECT_ROOT}/api-server && npm install

echo "âœ… å…¨ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
'''

# ============ ã‚¯ãƒªãƒ¼ãƒ³ ============

[tasks.clean]
description = "ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤"
script = '''
echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤ä¸­..."

rm -rf ${PROJECT_ROOT}/lean-backend/.lake
rm -rf ${PROJECT_ROOT}/frontend/dist
rm -rf ${PROJECT_ROOT}/api-server/dist

echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³å®Œäº†"
'''

# ============ ãƒ†ã‚¹ãƒˆ ============

[tasks.test-lean]
description = "Leanã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
script = '''
echo "ğŸ§ª Leanãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
cd ${PROJECT_ROOT}/lean-backend && lake build
echo "âœ… Leanãƒ“ãƒ«ãƒ‰æˆåŠŸï¼ˆsorry ãªã—ï¼‰"
'''

[tasks.test-scenarios]
description = "ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã§JSONRPCã‚’ãƒ†ã‚¹ãƒˆ"
script = '''
echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’å®Ÿè¡Œä¸­..."
cd ${PROJECT_ROOT}/lean-backend && echo '{"jsonrpc":"2.0","method":"ping","params":{},"id":1}' | lake env lean --run Main.lean
'''
